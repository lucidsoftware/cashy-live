#!/bin/bash

VERSION_PREFIX=$1

if [ -z $VERSION_PREFIX ]; then
    echo "usage: $0 <VERSION_PREFIX>"
    echo "got: $0 $VERSION_PREFIX"
    exit 1;
fi

if [ -z "$SERVER_HOME" ]
then
   SERVER_HOME=`pwd`
fi

#create a directory to use for building the .deb
DIST_DIR=$SERVER_HOME/dist;
[ -e "${DIST_DIR}" ] &&  rm -rf "${DIST_DIR}"
mkdir -p "${DIST_DIR}"

DEB_NAME=cashy-live
PACKAGING_DIR=$DIST_DIR/$DEB_NAME

if [ $VERSION_PREFIX = "master"  ];then
        VERSION=1.0-$BUILD_NUMBER
else
        VERSION=1.0-$VERSION_PREFIX$BUILD_NUMBER
fi


#create the control file
mkdir -p $PACKAGING_DIR/DEBIAN

#create the control file
echo "Package: $DEB_NAME-$VERSION_PREFIX
Version: 1
Section: devel
Priority: optional
Architecture: all
Maintainer: Lucid Software Team <ops@lucidchart.com>
Description: Cashy-live" >> $PACKAGING_DIR/DEBIAN/control

#pull in the postinst script
cp $SERVER_HOME/build/postinst $PACKAGING_DIR/DEBIAN

chmod -R 755 $PACKAGING_DIR/DEBIAN

INSTALL_DIR=$PACKAGING_DIR/srv/lucid-piezo-admin-service/bin
mkdir -p $INSTALL_DIR

cp -r $SERVER_HOME/target/universal/stage  $INSTALL_DIR/staged-$VERSION
echo $VERSION > $INSTALL_DIR/staged-version

#build the .deb
fakeroot dpkg-deb --build $PACKAGING_DIR
FINAL_DEB=${DIST_DIR}/${DEB_NAME}_${VERSION}.deb
cp ${DIST_DIR}/$DEB_NAME.deb $FINAL_DEB

exit $?
