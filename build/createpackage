#!/bin/bash

VERSION=$1

if [ -z $VERSION ]; then
    echo "usage: $0 <VERSION>"
    echo "got: $0 $VERSION"
    exit 1;
fi

if [ -z "$SERVER_HOME" ]
then
   SERVER_HOME=`pwd`
fi

#create a directory to use for building the .deb
DIST_DIR=$SERVER_HOME/dist;
[ -e "${DIST_DIR}" ] &&  rm -rf "${DIST_DIR}"
mkdir -p "${DIST_DIR}"

DEB_NAME=cashy-live
PACKAGING_DIR=$DIST_DIR/$DEB_NAME

#create the control file
mkdir -p $PACKAGING_DIR/DEBIAN

#create the control file
echo "Package: $DEB_NAME-$VERSION
Version: 1
Section: devel
Priority: optional
Architecture: all
Maintainer: Lucid Software Team <ops@lucidchart.com>
Description: Cashy-live" >> $PACKAGING_DIR/DEBIAN/control

#pull in the postinst script
cp $SERVER_HOME/build/postinst $PACKAGING_DIR/DEBIAN

chmod -R 755 $PACKAGING_DIR/DEBIAN

INSTALL_DIR=$PACKAGING_DIR/srv/lucid-piezo-admin-service/bin
mkdir -p $INSTALL_DIR

cp -r $SERVER_HOME/target/universal/stage  $INSTALL_DIR/staged-$VERSION
echo $VERSION > $INSTALL_DIR/staged-version

#build the .deb
fakeroot dpkg-deb --build $PACKAGING_DIR
FINAL_DEB=${DIST_DIR}/${DEB_NAME}_1.0-${VERSION}.deb
cp ${DIST_DIR}/$DEB_NAME.deb $FINAL_DEB

exit $?
